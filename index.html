<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com https://www.gstatic.com https://www.google.com https://www.googleapis.com; 
                   script-src-elem 'self' 'unsafe-inline' https://www.gstatic.com https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://www.google.com;
                   connect-src 'self' https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://firebaseinstallations.googleapis.com https://appcheck.googleapis.com https://www.googleapis.com wss://*.firebaseio.com https://www.google.com;
                   frame-src 'self' https://www.youtube.com https://trytako.com https://www.google.com; 
                   child-src 'self'; 
                   manifest-src 'self'; 
                   worker-src 'self'; 
                   upgrade-insecure-requests; 
                   block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persiche Ecke POS</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check-compat.js"></script>

<script>
  // Firebase Config
  const firebaseConfig = {
    // IMPORTANT: Replace with your actual Firebase configuration values
    apiKey: "AIzaSyBrorolxR3dmiY8jeXhsrIWR_x64aSV_sY", // Example, use your own
    authDomain: "poshohenheim.firebaseapp.com",       // Example, use your own
    projectId: "poshohenheim",                       // Example, use your own
    storageBucket: "poshohenheim.firebasestorage.app", // Example, use your own
    messagingSenderId: "755978169009",               // Example, use your own
    appId: "1:755978169009:web:2bef63525b29980b391090" // Example, use your own
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);

  // Enable reCAPTCHA App Check
  // IMPORTANT: For production, use a site key for reCAPTCHA v3 or Enterprise.
  // The key '6LcgkDMrAAAAAMUjTMOb8rMK4tXiemU5pAYvNeK0' looks like a reCAPTCHA v2 site key
  // or a test key. For App Check with reCAPTCHA v3, you typically register your site
  // in the Firebase console and get a site key.
  // The `true` flag enables debug mode for App Check, which is not for production.
  const appCheck = firebase.appCheck();
  appCheck.activate('6LcgkDMrAAAAAMUjTMOb8rMK4tXiemU5pAYvNeK0', true); // Ensure this key is correct for your setup

  // Initialize services
  const db = firebase.firestore();
  const auth = firebase.auth();

  // Enable offline persistence
  db.enablePersistence().catch(err => {
    if (err.code === 'failed-precondition') {
      console.warn('Multiple tabs open, offline persistence may not work as expected.');
    } else if (err.code === 'unimplemented') {
      console.warn('Offline persistence is not supported in this browser.');
    } else {
      console.error('Failed to enable offline persistence:', err);
    }
  });

  // Anonymous Sign-In
  auth.signInAnonymously()
    .then(() => {
      console.log("Signed in anonymously successfully.");
    })
    .catch(error => {
      console.error("Anonymous authentication error:", error);
    });
</script>


    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        // Tailwind CSS Configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        order: '#3b82f6',
                        kitchen: '#ef4444',
                        completed: '#10b981',
                        config: '#8b5cf6',
                        food: '#e67e22',
                        beverage: '#3498db',
                        dessert: '#9b59b6'
                    }
                }
            },
            darkMode: 'class', // or 'media' if you prefer OS-level dark mode detection
        }
    </script>
    <style>
        /* Custom scrollbar styles */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1); /* Light mode track */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2); /* Light mode thumb */
            border-radius: 4px;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1); /* Dark mode track */
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2); /* Dark mode thumb */
        }
        
        /* Category heading base styles */
        .category-heading {
            @apply text-lg font-semibold mb-2 mt-4 border-b pb-1;
        }
        
        /* Specific category heading colors */
        .food-heading {
            @apply text-food border-food/30;
        }
        
        .beverage-heading {
            @apply text-beverage border-beverage/30;
        }
        
        .dessert-heading {
            @apply text-dessert border-dessert/30;
        }
        
        /* Sync and auth indicator styles */
        .status-indicator {
            @apply fixed bottom-4 right-4 bg-white dark:bg-gray-800 p-2 rounded-full shadow-lg z-50 flex items-center space-x-2 text-sm;
        }
        
        .sync-spinner {
            @apply animate-spin h-5 w-5 text-primary;
        }
        
        .auth-badge {
            @apply fixed bottom-4 left-4 bg-white dark:bg-gray-800 px-3 py-1 rounded-full shadow-lg z-50 flex items-center text-sm;
        }
        
        .auth-indicator {
            @apply h-3 w-3 rounded-full mr-2;
        }
        
        .auth-active {
            @apply bg-green-500;
        }
        
        .auth-inactive {
            @apply bg-red-500;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen transition-colors duration-200 font-sans">
    
    <div id="sync-indicator" class="status-indicator hidden">
        <svg class="sync-spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span id="sync-status">Syncing...</span>
    </div>
    
    <div id="auth-badge" class="auth-badge">
        <span id="auth-indicator" class="auth-indicator auth-inactive"></span>
        <span id="auth-status">Connecting...</span>
    </div>
    
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-center text-primary">Persiche Ecke POS</h1>
        </header>

        <div class="flex flex-wrap mb-6 gap-2">
            <button id="tab-new-order" class="px-4 py-3 rounded-lg bg-order text-white font-semibold flex-grow shadow hover:bg-blue-700 transition-colors"><i class="fas fa-utensils mr-2"></i>New Order</button>
            <button id="tab-kitchen" class="px-4 py-3 rounded-lg bg-kitchen text-white font-semibold flex-grow shadow hover:bg-red-700 transition-colors"><i class="fas fa-fire mr-2"></i>Kitchen Orders</button>
            <button id="tab-history" class="px-4 py-3 rounded-lg bg-completed text-white font-semibold flex-grow shadow hover:bg-green-700 transition-colors"><i class="fas fa-history mr-2"></i>Order History</button>
            <button id="tab-config" class="px-4 py-3 rounded-lg bg-config text-white font-semibold flex-grow shadow hover:bg-purple-700 transition-colors"><i class="fas fa-cog mr-2"></i>Menu Config</button>
            <button id="tab-summary" class="px-4 py-3 rounded-lg bg-yellow-600 text-white font-semibold flex-grow shadow hover:bg-yellow-700 transition-colors"><i class="fas fa-chart-bar mr-2"></i>Sales Summary</button>
        </div>
        
        <div id="summary-tab" class="tab-content hidden">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-yellow-600">Sales Summary</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg shadow">
                        <h3 class="text-lg font-medium mb-2">Total Orders</h3>
                        <p id="total-orders-count" class="text-3xl font-bold">0</p>
                    </div>
                    
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg shadow">
                        <h3 class="text-lg font-medium mb-2">Total Revenue</h3>
                        <p id="total-revenue" class="text-3xl font-bold">$0.00</p>
                    </div>
                    
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg shadow">
                        <h3 class="text-lg font-medium mb-2">Average Order Value</h3>
                        <p id="average-order-value" class="text-3xl font-bold">$0.00</p>
                    </div>
                </div>
                
                <div class="mb-8">
                    <h3 class="text-lg font-medium mb-4">Top Selling Items</h3>
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full min-w-[400px]">
                            <thead>
                                <tr class="border-b dark:border-gray-700">
                                    <th class="text-left py-2 px-3">Item Name</th>
                                    <th class="text-right py-2 px-3">Quantity Sold</th>
                                    <th class="text-right py-2 px-3">Revenue</th>
                                </tr>
                            </thead>
                            <tbody id="top-items" class="divide-y divide-gray-200 dark:divide-gray-700">
                                </tbody>
                        </table>
                    </div>
                    <div id="no-top-items" class="text-center py-8 text-gray-500 dark:text-gray-400">
                        No sales data available
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-medium mb-4">Data Export</h3>
                    <button id="export-csv" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition shadow">
                        <i class="fas fa-file-csv mr-2"></i> Export Sales Data (CSV)
                    </button>
                </div>
            </div>
        </div>

        <div id="new-order-tab" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                <div class="lg:col-span-3 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 text-order">Menu Items</h2>
                    
                    <div id="menu-items-container" class="overflow-y-auto max-h-[70vh] custom-scrollbar p-1">
                        <h3 class="category-heading food-heading"><i class="fas fa-utensils mr-2"></i>Food</h3>
                        <div id="food-items" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 mb-4">
                            </div>
                        
                        <h3 class="category-heading beverage-heading"><i class="fas fa-coffee mr-2"></i>Beverages</h3>
                        <div id="beverage-items" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 mb-4">
                            </div>
                        
                        <h3 class="category-heading dessert-heading"><i class="fas fa-ice-cream mr-2"></i>Desserts</h3>
                        <div id="dessert-items" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                            </div>
                    </div>
                </div>

                <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 text-order">Current Order</h2>
                    <div class="mb-4 max-h-[300px] overflow-y-auto custom-scrollbar">
                        <table class="w-full min-w-[300px]">
                            <thead>
                                <tr class="border-b dark:border-gray-700">
                                    <th class="text-left py-2 px-1">Item</th>
                                    <th class="text-center py-2 px-1">Qty</th>
                                    <th class="text-right py-2 px-1">Price</th>
                                    <th class="text-right py-2 px-1">Action</th>
                                </tr>
                            </thead>
                            <tbody id="order-items">
                                </tbody>
                        </table>
                    </div>
                    
                    <div class="space-y-2 mb-4 border-t dark:border-gray-700 pt-4">
                        <div class="flex justify-between">
                            <span>Subtotal:</span>
                            <span id="subtotal" class="font-semibold">$0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Discount:</span>
                            <span id="discount" class="font-semibold">$0.00</span>
                        </div>
                        <div class="flex justify-between text-lg">
                            <span>Total:</span>
                            <span id="total" class="font-bold text-primary">$0.00</span>
                        </div>
                    </div>

                    <div class="mb-4 grid grid-cols-3 gap-2">
                        <div class="col-span-1">
                            <label for="discount-percent" class="block mb-1 text-sm">Discount %:</label>
                            <input type="number" id="discount-percent" class="w-full p-2 border dark:border-gray-600 rounded-lg dark:bg-gray-700 text-base shadow-sm focus:ring-primary focus:border-primary" min="0" max="100" value="10">
                        </div>
                        <div class="col-span-2 flex items-end">
                            <button id="apply-discount" class="w-full bg-yellow-500 text-white py-2 rounded-lg font-semibold hover:bg-yellow-600 transition shadow">
                                Apply Discount
                            </button>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="amount-received" class="block mb-2">Amount Received:</label>
                        <input type="number" id="amount-received" class="w-full p-2 border dark:border-gray-600 rounded-lg dark:bg-gray-700 text-base shadow-sm focus:ring-primary focus:border-primary" min="0" step="0.01">
                    </div>
                    
                    <div class="mb-6">
                        <label for="change" class="block mb-2">Change to Return:</label>
                        <input type="text" id="change" class="w-full p-2 border dark:border-gray-600 rounded-lg dark:bg-gray-600 bg-gray-100 dark:bg-gray-800/50" readonly>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <button id="clear-order" class="bg-gray-500 text-white py-3 rounded-lg font-semibold hover:bg-gray-600 transition shadow">
                            Clear Order
                        </button>
                        <button id="confirm-order" class="bg-order text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition shadow">
                            Confirm Order
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="kitchen-tab" class="tab-content hidden">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-kitchen">Kitchen Orders</h2>
                <div id="kitchen-orders" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
                <div id="no-kitchen-orders" class="text-center py-8 text-gray-500 dark:text-gray-400">
                    No pending orders
                </div>
            </div>
        </div>

        <div id="history-tab" class="tab-content hidden">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-completed">Order History</h2>
                <div class="space-y-2 mb-6">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-medium">Completed Orders</h3>
                        <div class="flex items-center">
                            <span class="mr-2">Total Sales:</span>
                            <span id="history-total-sales" class="font-bold text-lg text-completed">$0.00</span>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="w-full min-w-[600px]">
                        <thead>
                            <tr class="border-b dark:border-gray-700">
                                <th class="text-left py-2 px-3">Order ID</th>
                                <th class="text-left py-2 px-3">Date & Time</th>
                                <th class="text-left py-2 px-3">Items</th>
                                <th class="text-right py-2 px-3">Total</th>
                                <th class="text-right py-2 px-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="history-items" class="divide-y divide-gray-200 dark:divide-gray-700">
                            </tbody>
                    </table>
                </div>
                <div id="no-history" class="text-center py-8 text-gray-500 dark:text-gray-400">
                    No order history yet
                </div>
            </div>
        </div>

        <div id="config-tab" class="tab-content hidden">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-config">Menu Configuration</h2>
                
                <div class="mb-8 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow">
                    <h3 class="text-lg font-medium mb-4">Add New Menu Item</h3>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div class="md:col-span-2">
                            <label for="item-name" class="block mb-2">Item Name:</label>
                            <input type="text" id="item-name" class="w-full p-2 border dark:border-gray-600 rounded-lg dark:bg-gray-800 text-base shadow-sm focus:ring-config focus:border-config" placeholder="e.g. Cheeseburger">
                        </div>
                        <div>
                            <label for="item-price" class="block mb-2">Price ($):</label>
                            <input type="number" id="item-price" class="w-full p-2 border dark:border-gray-600 rounded-lg dark:bg-gray-800 text-base shadow-sm focus:ring-config focus:border-config" min="0" step="0.01" placeholder="9.99">
                        </div>
                        <div>
                            <label for="item-category" class="block mb-2">Category:</label>
                            <select id="item-category" class="w-full p-2 border dark:border-gray-600 rounded-lg dark:bg-gray-800 text-base shadow-sm focus:ring-config focus:border-config">
                                <option value="food">Food</option>
                                <option value="beverage">Beverage</option>
                                <option value="dessert">Dessert</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button id="add-item" class="w-full bg-config text-white py-2 rounded-lg font-semibold hover:bg-purple-700 transition shadow">
                                Add Item
                            </button>
                        </div>
                    </div>
                </div>
                
                <h3 class="text-lg font-medium mb-4">Current Menu Items</h3>
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="w-full min-w-[500px]">
                        <thead>
                            <tr class="border-b dark:border-gray-700">
                                <th class="text-left py-2 px-3">Item Name</th>
                                <th class="text-left py-2 px-3">Category</th>
                                <th class="text-right py-2 px-3">Price</th>
                                <th class="text-right py-2 px-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="menu-config-items" class="divide-y divide-gray-200 dark:divide-gray-700">
                            </tbody>
                    </table>
                </div>
                <div id="no-menu-items" class="text-center py-8 text-gray-500 dark:text-gray-400">
                    No menu items yet. Add some items above!
                </div>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg w-full max-w-md shadow-xl">
            <h3 class="text-lg font-semibold mb-4">Edit Menu Item</h3>
            <input type="hidden" id="edit-item-id">
            <div class="mb-4">
                <label for="edit-item-name" class="block mb-2">Item Name:</label>
                <input type="text" id="edit-item-name" class="w-full p-2 border dark:border-gray-600 rounded-lg dark:bg-gray-700 text-base focus:ring-config focus:border-config">
            </div>
            <div class="mb-4">
                <label for="edit-item-price" class="block mb-2">Price ($):</label>
                <input type="number" id="edit-item-price" class="w-full p-2 border dark:border-gray-600 rounded-lg dark:bg-gray-700 text-base focus:ring-config focus:border-config" min="0" step="0.01">
            </div>
            <div class="mb-4">
                <label for="edit-item-category" class="block mb-2">Category:</label>
                <select id="edit-item-category" class="w-full p-2 border dark:border-gray-600 rounded-lg dark:bg-gray-700 text-base focus:ring-config focus:border-config">
                    <option value="food">Food</option>
                    <option value="beverage">Beverage</option>
                    <option value="dessert">Dessert</option>
                </select>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancel-edit" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition shadow">
                    Cancel
                </button>
                <button id="save-edit" class="px-4 py-2 bg-config text-white rounded-lg hover:bg-purple-700 transition shadow">
                    Save Changes
                </button>
            </div>
        </div>
    </div>
    
    <div id="edit-order-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg w-full max-w-lg shadow-xl">
            <h3 class="text-lg font-semibold mb-4">Edit Order</h3>
            <input type="hidden" id="edit-order-id">
            <input type="hidden" id="edit-order-type">
            
            <div class="mb-4 max-h-[400px] overflow-y-auto custom-scrollbar">
                <table class="w-full min-w-[400px]">
                    <thead>
                        <tr class="border-b dark:border-gray-700">
                            <th class="text-left py-2 px-1">Item</th>
                            <th class="text-center py-2 px-1">Qty</th>
                            <th class="text-right py-2 px-1">Price</th>
                            <th class="text-right py-2 px-1">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="edit-order-items">
                        </tbody>
                </table>
            </div>
            
            <div class="space-y-2 mb-4 border-t dark:border-gray-700 pt-4">
                <div class="flex justify-between">
                    <span>Subtotal:</span>
                    <span id="edit-subtotal" class="font-semibold">$0.00</span>
                </div>
                <div class="grid grid-cols-3 gap-2 items-center">
                    <div class="col-span-1">
                        <label for="edit-discount-percent" class="text-sm">Discount %:</label>
                        <input type="number" id="edit-discount-percent" class="w-full p-2 border dark:border-gray-600 rounded-lg dark:bg-gray-700 text-base focus:ring-primary focus:border-primary" min="0" max="100" value="0">
                    </div>
                    <div class="col-span-1 text-right">
                        <span>Discount:</span>
                    </div>
                    <div class="col-span-1 text-right">
                        <span id="edit-discount" class="font-semibold">$0.00</span>
                    </div>
                </div>
                <div class="flex justify-between text-lg">
                    <span>Total:</span>
                    <span id="edit-total" class="font-bold text-primary">$0.00</span>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button id="cancel-edit-order" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition shadow">
                    Cancel
                </button>
                <button id="save-edit-order" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition shadow">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize dark mode based on system preference or saved preference
        // Function to apply dark mode
        function applyDarkMode(isDark) {
            if (isDark) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        // Check localStorage for saved preference
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            applyDarkMode(savedTheme === 'dark');
        } else {
            // Fallback to system preference if no saved theme
            applyDarkMode(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
        }
        
        // Listen for changes in system preference
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            // Only change if no theme is explicitly saved by user interaction (e.g., a theme toggle button)
            if (!localStorage.getItem('theme')) {
                applyDarkMode(event.matches);
            }
        });


        // POS Application Logic
        const POS = {
            menuItems: [],
            currentOrder: {
                items: [],
                subtotal: 0,
                discount: 0,
                total: 0,
                discountApplied: false,
                discountPercent: 10 // Default discount percentage
            },
            kitchenOrders: [],
            orderHistory: [],
            orderCounter: 1000, // Starting order number
            syncStatus: {
                active: false,
                lastSynced: null
            },
            
            // Show sync status indicator
            showSyncIndicator(message = "Syncing...") {
                this.syncStatus.active = true;
                document.getElementById('sync-indicator').classList.remove('hidden');
                document.getElementById('sync-status').textContent = message;
            },
            
            // Hide sync status indicator
            hideSyncIndicator() {
                this.syncStatus.active = false;
                document.getElementById('sync-indicator').classList.add('hidden');
                this.syncStatus.lastSynced = new Date();
            },
            
            // Update authentication status display
            updateAuthStatusDisplay(isAuthenticated, message = '') {
                const authIndicator = document.getElementById('auth-indicator');
                const authStatusEl = document.getElementById('auth-status');
                
                if (isAuthenticated) {
                    authIndicator.classList.add('auth-active');
                    authIndicator.classList.remove('auth-inactive');
                    authStatusEl.textContent = message || 'Authenticated';
                } else {
                    authIndicator.classList.remove('auth-active');
                    authIndicator.classList.add('auth-inactive');
                    authStatusEl.textContent = message || 'Not Authenticated';
                }
            },
            
            // Generate a unique order ID
            generateOrderId() {
                this.orderCounter++;
                this.saveOrderCounter(); // Save immediately
                return 'PE-' + this.orderCounter;
            },
            
            // Initialize the application
            init() {
                this.showSyncIndicator("Initializing POS...");
                this.updateAuthStatusDisplay(false, "Connecting..."); // Initial auth status
                
                // Set up auth state listener
                auth.onAuthStateChanged(user => {
                    if (user) {
                        console.log("Firebase Auth: User is signed in.", user.uid);
                        this.updateAuthStatusDisplay(true, "Authenticated");
                        this.setupFirebaseListeners(); // Setup listeners now that user is authenticated
                        this.loadOrderCounter(); // Load counter after auth, potentially from Firebase
                    } else {
                        console.log("Firebase Auth: User is signed out. Attempting anonymous sign-in.");
                        this.updateAuthStatusDisplay(false, "Authenticating...");
                        // Try to sign in anonymously again if not signed in
                        auth.signInAnonymously().catch(error => {
                            console.error("Firebase Auth: Anonymous sign-in failed on attempt:", error);
                            this.updateAuthStatusDisplay(false, "Auth Failed");
                            // Fall back to local data if authentication fails critically
                            this.loadFromLocalStorage(); 
                        });
                    }
                });
                
                // Initial load of order counter from localStorage, Firebase will update if available
                const localCounter = localStorage.getItem('pos_orderCounter');
                if (localCounter) {
                    this.orderCounter = parseInt(localCounter);
                }

                this.setupEventListeners();
                this.showTab('new-order-tab'); // Show new order tab by default
                this.renderAll(); // Initial render with local/default data
            },
            
            // Load all data from localStorage as a fallback
            loadFromLocalStorage() {
                console.warn("Loading all data from localStorage due to Firebase issues.");
                this.loadMenuItemsFromLocal();
                this.loadKitchenOrdersFromLocal();
                this.loadOrderHistoryFromLocal();
                this.hideSyncIndicator();
            },
            
            // Set up Firebase real-time listeners for data synchronization
            setupFirebaseListeners() {
                console.log("Setting up Firebase listeners.");
                this.showSyncIndicator("Connecting to Database...");

                // Listen for menu items changes
                db.collection('config').doc('menuItems').onSnapshot(doc => {
                    this.showSyncIndicator("Syncing menu...");
                    if (doc.exists && doc.data().items) {
                        console.log("Firebase: Menu items loaded.");
                        this.menuItems = doc.data().items;
                    } else {
                        console.warn("Firebase: No menu items found in database. Using local/default.");
                        this.loadMenuItemsFromLocal(); // Load local/default if nothing in Firebase
                    }
                    this.renderMenuItems();
                    this.renderMenuConfigItems();
                    this.hideSyncIndicator();
                }, error => {
                    console.error("Firebase: Menu items listener error: ", error);
                    this.loadMenuItemsFromLocal(); // Fallback on error
                    this.hideSyncIndicator();
                });
                
                // Listen for kitchen orders changes
                db.collection('kitchenOrders').orderBy('createdAt', 'asc').onSnapshot(snapshot => {
                    this.showSyncIndicator("Syncing kitchen orders...");
                    this.kitchenOrders = [];
                    snapshot.forEach(doc => {
                        this.kitchenOrders.push({ id: doc.id, ...doc.data() });
                    });
                    console.log("Firebase: Kitchen orders updated.", this.kitchenOrders.length);
                    this.renderKitchenOrders();
                    this.hideSyncIndicator();
                }, error => {
                    console.error("Firebase: Kitchen orders listener error: ", error);
                    this.loadKitchenOrdersFromLocal(); // Fallback
                    this.hideSyncIndicator();
                });
                
                // Listen for order history changes
                db.collection('orderHistory').orderBy('completedAt', 'desc').onSnapshot(snapshot => {
                    this.showSyncIndicator("Syncing order history...");
                    this.orderHistory = [];
                    snapshot.forEach(doc => {
                        this.orderHistory.push({ id: doc.id, ...doc.data() });
                    });
                    console.log("Firebase: Order history updated.", this.orderHistory.length);
                    this.renderOrderHistory();
                    this.updateSalesStats();
                    this.updateHistoryTotalSales();
                    this.hideSyncIndicator();
                }, error => {
                    console.error("Firebase: Order history listener error: ", error);
                    this.loadOrderHistoryFromLocal(); // Fallback
                    this.hideSyncIndicator();
                });
                
                // Listen for order counter changes
                db.collection('config').doc('orderCounter').onSnapshot(doc => {
                    if (doc.exists && doc.data().counter) {
                        const firebaseCounter = parseInt(doc.data().counter);
                        if (firebaseCounter > this.orderCounter) {
                             this.orderCounter = firebaseCounter;
                             console.log("Firebase: Order counter updated from Firebase:", this.orderCounter);
                        }
                    }
                }, error => {
                    console.error("Firebase: Order counter listener error:", error);
                });
            },
            
            // Save order counter to Firebase and localStorage
            saveOrderCounter() {
                localStorage.setItem('pos_orderCounter', this.orderCounter.toString());
                
                if (!auth.currentUser) {
                    console.warn("Not authenticated, saving order counter to localStorage only.");
                    return;
                }
                
                console.log("Saving order counter to Firebase:", this.orderCounter);
                db.collection('config').doc('orderCounter').set({
                    counter: this.orderCounter
                }).catch(error => {
                    console.error("Firebase: Error saving order counter: ", error);
                });
            },
            
            // Load order counter (prefer Firebase if available, else localStorage)
            loadOrderCounter() {
                const localCounter = localStorage.getItem('pos_orderCounter');
                if (localCounter) {
                    this.orderCounter = Math.max(this.orderCounter, parseInt(localCounter));
                }

                if (auth.currentUser) {
                    db.collection('config').doc('orderCounter').get()
                        .then(doc => {
                            if (doc.exists && doc.data().counter) {
                                const firebaseCounter = parseInt(doc.data().counter);
                                // Ensure Firebase counter doesn't overwrite a higher local one if Firebase is lagging
                                this.orderCounter = Math.max(this.orderCounter, firebaseCounter);
                                console.log("Order counter loaded/updated from Firebase:", this.orderCounter);
                            } else {
                                // If no counter in Firebase, save the current one (from local or default)
                                this.saveOrderCounter();
                            }
                        })
                        .catch(error => {
                            console.error("Firebase: Error loading order counter: ", error);
                        });
                }
            },
            
            // Load menu items from localStorage or use defaults if none
            loadMenuItemsFromLocal() {
                const stored = localStorage.getItem('pos_menuItems');
                if (stored) {
                    this.menuItems = JSON.parse(stored);
                    console.log("Menu items loaded from localStorage.");
                } else {
                    // Default menu items if nothing in localStorage or Firebase
                    this.menuItems = [
                        { id: '1', name: 'Cheeseburger', price: 8.99, category: 'food' },
                        { id: '2', name: 'Pizza Margherita', price: 12.99, category: 'food' },
                        { id: '3', name: 'Caesar Salad', price: 6.99, category: 'food' },
                        { id: '4', name: 'French Fries', price: 3.99, category: 'food' },
                        { id: '5', name: 'Cola', price: 1.99, category: 'beverage' },
                        { id: '6', name: 'Espresso', price: 2.99, category: 'beverage' },
                        { id: '7', name: 'Vanilla Ice Cream', price: 4.99, category: 'dessert' },
                        { id: '8', name: 'Chocolate Cake', price: 5.99, category: 'dessert' }
                    ];
                    console.log("Default menu items loaded.");
                    this.saveMenuItems(); // Save defaults if it's the first run
                }
                this.renderMenuItems();
                this.renderMenuConfigItems();
            },
            
            // Load kitchen orders from localStorage
            loadKitchenOrdersFromLocal() {
                const stored = localStorage.getItem('pos_kitchenOrders');
                if (stored) {
                    this.kitchenOrders = JSON.parse(stored);
                    this.renderKitchenOrders();
                    console.log("Kitchen orders loaded from localStorage.");
                }
            },
            
            // Load order history from localStorage
            loadOrderHistoryFromLocal() {
                const stored = localStorage.getItem('pos_orderHistory');
                if (stored) {
                    this.orderHistory = JSON.parse(stored);
                    this.renderOrderHistory();
                    this.updateSalesStats();
                    this.updateHistoryTotalSales();
                    console.log("Order history loaded from localStorage.");
                }
            },
            
            // Save menu items to Firebase and localStorage
            saveMenuItems() {
                localStorage.setItem('pos_menuItems', JSON.stringify(this.menuItems));
                if (!auth.currentUser) {
                    console.warn("Not authenticated, saving menu items to localStorage only.");
                    return;
                }
                this.showSyncIndicator("Saving menu...");
                db.collection('config').doc('menuItems').set({ items: this.menuItems })
                    .then(() => { console.log("Firebase: Menu items saved."); this.hideSyncIndicator(); })
                    .catch(error => { console.error("Firebase: Error saving menu items: ", error); this.hideSyncIndicator(); });
            },
            
            // Save kitchen orders (individual documents in Firebase)
            saveKitchenOrderToFirebase(order) {
                if (!auth.currentUser) {
                     console.warn("Not authenticated, kitchen order changes might not persist to Firebase.");
                     // LocalStorage is updated by saveKitchenOrdersLocally
                     return;
                }
                this.showSyncIndicator("Saving kitchen order...");
                // Use order.id as document ID
                db.collection('kitchenOrders').doc(order.id).set(order)
                    .then(() => { console.log("Firebase: Kitchen order saved/updated:", order.id); this.hideSyncIndicator(); })
                    .catch(error => { console.error("Firebase: Error saving kitchen order:", order.id, error); this.hideSyncIndicator(); });
            },

            deleteKitchenOrderFromFirebase(orderId) {
                if (!auth.currentUser) {
                    console.warn("Not authenticated, kitchen order deletion might not persist to Firebase.");
                    return;
                }
                this.showSyncIndicator("Deleting kitchen order...");
                db.collection('kitchenOrders').doc(orderId).delete()
                    .then(() => { console.log("Firebase: Kitchen order deleted:", orderId); this.hideSyncIndicator(); })
                    .catch(error => { console.error("Firebase: Error deleting kitchen order:", orderId, error); this.hideSyncIndicator(); });
            },
            
            // Save order history (individual documents in Firebase)
            saveOrderToHistoryInFirebase(order) {
                 if (!auth.currentUser) {
                     console.warn("Not authenticated, order history changes might not persist to Firebase.");
                     return;
                 }
                this.showSyncIndicator("Saving to order history...");
                // Use order.id as document ID
                db.collection('orderHistory').doc(order.id).set(order)
                    .then(() => { console.log("Firebase: Order saved to history:", order.id); this.hideSyncIndicator(); })
                    .catch(error => { console.error("Firebase: Error saving order to history:", order.id, error); this.hideSyncIndicator(); });
            },

            // Update local storage for kitchen orders and order history
            saveKitchenOrdersLocally() {
                localStorage.setItem('pos_kitchenOrders', JSON.stringify(this.kitchenOrders));
            },
            saveOrderHistoryLocally() {
                localStorage.setItem('pos_orderHistory', JSON.stringify(this.orderHistory));
                this.updateSalesStats();
                this.updateHistoryTotalSales();
                this.exportDataToCSV(); // Update CSV export data
            },

            // Menu item operations
            addMenuItem(name, price, category) {
                const id = Date.now().toString(); // Simple unique ID
                this.menuItems.push({ id, name, price: parseFloat(price), category });
                this.saveMenuItems(); // Saves to both Firebase and localStorage
                this.renderMenuConfigItems(); // Re-render the config list
                this.renderMenuItems(); // Re-render the order menu
            },
            
            updateMenuItem(id, name, price, category) {
                const index = this.menuItems.findIndex(item => item.id === id);
                if (index !== -1) {
                    this.menuItems[index] = { id, name, price: parseFloat(price), category };
                    this.saveMenuItems();
                    this.renderMenuConfigItems();
                    this.renderMenuItems();
                }
            },
            
            deleteMenuItem(id) {
                this.menuItems = this.menuItems.filter(item => item.id !== id);
                this.saveMenuItems();
                this.renderMenuConfigItems();
                this.renderMenuItems();
            },
            
            // Current Order operations
            addItemToOrder(itemId) {
                const menuItem = this.menuItems.find(item => item.id === itemId);
                if (!menuItem) return;
                
                const existingItem = this.currentOrder.items.find(item => item.id === itemId);
                if (existingItem) {
                    existingItem.quantity += 1;
                    existingItem.total = existingItem.quantity * existingItem.price;
                } else {
                    this.currentOrder.items.push({ ...menuItem, quantity: 1, total: menuItem.price });
                }
                this.updateOrderTotals();
                this.renderOrderItems();
            },
            
            removeItemFromOrder(itemId) {
                const itemIndex = this.currentOrder.items.findIndex(item => item.id === itemId);
                if (itemIndex !== -1) {
                    if (this.currentOrder.items[itemIndex].quantity > 1) {
                        this.currentOrder.items[itemIndex].quantity -= 1;
                        this.currentOrder.items[itemIndex].total = this.currentOrder.items[itemIndex].quantity * this.currentOrder.items[itemIndex].price;
                    } else {
                        this.currentOrder.items.splice(itemIndex, 1);
                    }
                    this.updateOrderTotals();
                    this.renderOrderItems();
                }
            },
            
            updateOrderTotals(orderObject = this.currentOrder, subtotalElId = 'subtotal', discountElId = 'discount', totalElId = 'total') {
                orderObject.subtotal = orderObject.items.reduce((sum, item) => sum + item.total, 0);
                
                if (orderObject.discountApplied && orderObject.discountPercent >= 0) {
                    orderObject.discount = orderObject.subtotal * (orderObject.discountPercent / 100);
                } else {
                    orderObject.discount = 0; // No discount if not applied or percent is invalid
                }
                
                orderObject.total = orderObject.subtotal - orderObject.discount;
                
                document.getElementById(subtotalElId).textContent = '$' + orderObject.subtotal.toFixed(2);
                document.getElementById(discountElId).textContent = '$' + orderObject.discount.toFixed(2);
                document.getElementById(totalElId).textContent = '$' + orderObject.total.toFixed(2);

                if (orderObject === this.currentOrder) { // Only for current order view
                    document.getElementById('amount-received').value = '';
                    document.getElementById('change').value = '';
                }
            },
            
            applyDiscount() {
                if (this.currentOrder.items.length > 0) {
                    const discountPercentInput = document.getElementById('discount-percent');
                    const discountPercent = parseFloat(discountPercentInput.value);
                    if (!isNaN(discountPercent) && discountPercent >= 0 && discountPercent <= 100) {
                        this.currentOrder.discountApplied = true;
                        this.currentOrder.discountPercent = discountPercent;
                        this.updateOrderTotals();
                    } else {
                        alert('Please enter a valid discount percentage (0-100).');
                        discountPercentInput.value = this.currentOrder.discountPercent; // Reset to previous valid
                    }
                }
            },
            
            calculateChange() {
                const amountReceivedInput = document.getElementById('amount-received');
                const amountReceived = parseFloat(amountReceivedInput.value);
                const changeInput = document.getElementById('change');

                if (!isNaN(amountReceived) && amountReceived >= this.currentOrder.total) {
                    const change = amountReceived - this.currentOrder.total;
                    changeInput.value = '$' + change.toFixed(2);
                } else if (!isNaN(amountReceived) && amountReceived < this.currentOrder.total) {
                     changeInput.value = 'Insufficient amount';
                } else {
                    changeInput.value = '';
                }
            },
            
            clearOrder() {
                this.currentOrder = {
                    items: [], subtotal: 0, discount: 0, total: 0,
                    discountApplied: false, discountPercent: 10 // Reset to default discount
                };
                this.renderOrderItems();
                this.updateOrderTotals();
                document.getElementById('discount-percent').value = '10';
                document.getElementById('amount-received').value = '';
                document.getElementById('change').value = '';
            },
            
            confirmOrder() {
                if (this.currentOrder.items.length === 0) {
                    alert('Cannot confirm an empty order.');
                    return;
                }
                
                const newOrder = {
                    id: this.generateOrderId(), // Generates and saves new counter
                    items: JSON.parse(JSON.stringify(this.currentOrder.items)), // Deep copy
                    subtotal: this.currentOrder.subtotal,
                    discount: this.currentOrder.discount,
                    discountPercent: this.currentOrder.discountPercent,
                    total: this.currentOrder.total,
                    timestamp: new Date().toISOString(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(), // Use server timestamp
                    status: 'pending', // e.g. pending, completed
                    userId: auth.currentUser ? auth.currentUser.uid : 'anonymous'
                };
                
                this.kitchenOrders.push(newOrder);
                this.saveKitchenOrderToFirebase(newOrder); // Save to Firebase
                this.saveKitchenOrdersLocally(); // Update local storage
                this.renderKitchenOrders();
                this.clearOrder();
            },
            
            completeOrder(orderId) {
                const orderIndex = this.kitchenOrders.findIndex(order => order.id === orderId);
                if (orderIndex !== -1) {
                    const completedOrder = {
                        ...this.kitchenOrders[orderIndex],
                        status: 'completed',
                        completedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        completedBy: auth.currentUser ? auth.currentUser.uid : 'anonymous'
                    };
                    
                    this.orderHistory.unshift(completedOrder); // Add to start of history
                    this.kitchenOrders.splice(orderIndex, 1); // Remove from kitchen
                    
                    this.saveOrderToHistoryInFirebase(completedOrder); // Save to Firebase history
                    this.deleteKitchenOrderFromFirebase(orderId); // Delete from Firebase kitchen orders
                    
                    this.saveKitchenOrdersLocally();
                    this.saveOrderHistoryLocally();

                    this.renderKitchenOrders();
                    this.renderOrderHistory();
                }
            },
            
            // Edit order functionality (simplified for this example, more robust logic might be needed)
            openEditOrderModal(order, type) {
                // Store the original order and type for saving
                this._editingOrder = JSON.parse(JSON.stringify(order)); // Deep copy for editing
                this._editingOrderType = type;

                document.getElementById('edit-order-id').value = this._editingOrder.id;
                document.getElementById('edit-order-type').value = type; // 'kitchen' or 'history'
                
                document.getElementById('edit-discount-percent').value = this._editingOrder.discountPercent || 0;
                
                this.renderEditOrderModalItems();
                this.updateOrderTotals(this._editingOrder, 'edit-subtotal', 'edit-discount', 'edit-total');
                
                document.getElementById('edit-order-modal').classList.remove('hidden');
            },

            renderEditOrderModalItems() {
                const itemsContainer = document.getElementById('edit-order-items');
                itemsContainer.innerHTML = '';
                this._editingOrder.items.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'border-b dark:border-gray-700';
                    row.innerHTML = `
                        <td class="py-2 px-1">${item.name}</td>
                        <td class="py-2 px-1 text-center">
                            <div class="flex items-center justify-center">
                                <button class="edit-qty-btn bg-gray-200 dark:bg-gray-700 px-2 rounded-l" data-item-id="${item.id}" data-action="subtract">-</button>
                                <span class="px-2 tabular-nums">${item.quantity}</span>
                                <button class="edit-qty-btn bg-gray-200 dark:bg-gray-700 px-2 rounded-r" data-item-id="${item.id}" data-action="add">+</button>
                            </div>
                        </td>
                        <td class="py-2 px-1 text-right tabular-nums">$${item.total.toFixed(2)}</td>
                        <td class="py-2 px-1 text-right">
                            <button class="edit-remove-item-btn text-red-500 hover:text-red-700" data-item-id="${item.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    itemsContainer.appendChild(row);
                });
            },

            handleEditOrderItemChange(itemId, action) {
                const itemIndex = this._editingOrder.items.findIndex(i => i.id === itemId);
                if (itemIndex === -1) return;

                const item = this._editingOrder.items[itemIndex];
                const menuItemDetails = this.menuItems.find(mi => mi.id === item.id) || { price: item.price }; // Fallback to item's price if not in current menu

                if (action === 'add') {
                    item.quantity++;
                } else if (action === 'subtract') {
                    item.quantity--;
                } else if (action === 'remove') {
                    item.quantity = 0; // Will be filtered out
                }

                if (item.quantity <= 0) {
                    this._editingOrder.items.splice(itemIndex, 1);
                } else {
                    item.total = item.quantity * menuItemDetails.price;
                }
                
                this.renderEditOrderModalItems();
                this.updateOrderTotals(this._editingOrder, 'edit-subtotal', 'edit-discount', 'edit-total');
            },

            applyEditOrderDiscount() {
                const discountPercentInput = document.getElementById('edit-discount-percent');
                const discountPercent = parseFloat(discountPercentInput.value);
                 if (!isNaN(discountPercent) && discountPercent >= 0 && discountPercent <= 100) {
                    this._editingOrder.discountApplied = true;
                    this._editingOrder.discountPercent = discountPercent;
                } else {
                    alert('Please enter a valid discount percentage (0-100).');
                    discountPercentInput.value = this._editingOrder.discountPercent; // Reset
                }
                this.updateOrderTotals(this._editingOrder, 'edit-subtotal', 'edit-discount', 'edit-total');
            },

            saveEditedOrder() {
                // Apply final discount calculation before saving
                this.applyEditOrderDiscount(); 

                this._editingOrder.lastModifiedAt = firebase.firestore.FieldValue.serverTimestamp();
                this._editingOrder.lastModifiedBy = auth.currentUser ? auth.currentUser.uid : 'anonymous';

                if (this._editingOrderType === 'kitchen') {
                    const index = this.kitchenOrders.findIndex(o => o.id === this._editingOrder.id);
                    if (index !== -1) {
                        this.kitchenOrders[index] = JSON.parse(JSON.stringify(this._editingOrder)); // Update local array
                        this.saveKitchenOrderToFirebase(this.kitchenOrders[index]);
                        this.saveKitchenOrdersLocally();
                        this.renderKitchenOrders();
                    }
                } else if (this._editingOrderType === 'history') {
                    const index = this.orderHistory.findIndex(o => o.id === this._editingOrder.id);
                    if (index !== -1) {
                        this.orderHistory[index] = JSON.parse(JSON.stringify(this._editingOrder)); // Update local array
                        this.saveOrderToHistoryInFirebase(this.orderHistory[index]);
                        this.saveOrderHistoryLocally();
                        this.renderOrderHistory();
                    }
                }
                document.getElementById('edit-order-modal').classList.add('hidden');
                this._editingOrder = null; // Clear editing state
            },
            
            // Sales statistics and history total
            updateSalesStats() { /* ... implementation from original ... */ },
            updateHistoryTotalSales() { /* ... implementation from original ... */ },
            exportDataToCSV() { /* ... implementation from original ... */ },
            downloadCSV() { /* ... implementation from original ... */ },
            
            // UI Rendering functions
            renderAll() {
                this.renderMenuItems();
                this.renderMenuConfigItems();
                this.renderOrderItems(); // For current order
                this.renderKitchenOrders();
                this.renderOrderHistory();
                this.updateSalesStats();
            },
            
            renderMenuItems() { /* ... implementation from original, ensure button dataset.id is correct ... */ },
            renderCategoryItems(items, containerId, category, icon) { /* ... implementation from original ... */ },
            renderMenuConfigItems() { /* ... implementation from original ... */ },
            renderOrderItems() { /* ... implementation from original ... */ },
            formatDateTime(isoStringOrTimestamp) {
                let date;
                if (isoStringOrTimestamp && typeof isoStringOrTimestamp.toDate === 'function') { // Firebase Timestamp object
                    date = isoStringOrTimestamp.toDate();
                } else if (isoStringOrTimestamp) {
                    date = new Date(isoStringOrTimestamp);
                } else {
                    return 'N/A'; // Or some placeholder for invalid dates
                }
                if (isNaN(date.getTime())) return 'Invalid Date';
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            },
            renderKitchenOrders() { /* ... use formatDateTime, ensure buttons have correct dataset.id ... */ },
            renderOrderHistory() { /* ... use formatDateTime, ensure buttons have correct dataset.id ... */ },
            
            // Event Listeners Setup
            setupEventListeners() {
                // Tab Navigation
                document.getElementById('tab-new-order').addEventListener('click', () => this.showTab('new-order-tab'));
                // ... other tab listeners ...

                // Menu Item Clicks (Event Delegation on parent containers)
                document.getElementById('menu-items-container').addEventListener('click', (e) => {
                    const button = e.target.closest('button[data-id]');
                    if (button) this.addItemToOrder(button.dataset.id);
                });
                
                // Current Order Item Removal
                document.getElementById('order-items').addEventListener('click', (e) => {
                    const button = e.target.closest('.remove-item-btn[data-id]');
                    if (button) this.removeItemFromOrder(button.dataset.id);
                });

                // Discount & Payment
                document.getElementById('apply-discount').addEventListener('click', () => this.applyDiscount());
                document.getElementById('amount-received').addEventListener('input', () => this.calculateChange());

                // Order Actions
                document.getElementById('clear-order').addEventListener('click', () => this.clearOrder());
                document.getElementById('confirm-order').addEventListener('click', () => this.confirmOrder());

                // Menu Configuration
                document.getElementById('add-item').addEventListener('click', () => { /* ... get values and call addMenuItem ... */ });
                document.getElementById('menu-config-items').addEventListener('click', (e) => {
                    const editBtn = e.target.closest('.edit-item-btn[data-id]');
                    if (editBtn) { /* ... find item and open edit modal ... */ }
                    const deleteBtn = e.target.closest('.delete-item-btn[data-id]');
                    if (deleteBtn) { /* ... confirm and call deleteMenuItem ... */ }
                });

                // Edit Menu Item Modal
                document.getElementById('cancel-edit').addEventListener('click', () => document.getElementById('edit-modal').classList.add('hidden'));
                document.getElementById('save-edit').addEventListener('click', () => { /* ... get values and call updateMenuItem ... */ });

                // Kitchen Orders Actions (Event Delegation)
                document.getElementById('kitchen-orders').addEventListener('click', (e) => {
                    const completeBtn = e.target.closest('.complete-order-btn[data-id]');
                    if (completeBtn) this.completeOrder(completeBtn.dataset.id);
                    
                    const editBtn = e.target.closest('.edit-kitchen-order-btn[data-id]');
                    if (editBtn) {
                        const order = this.kitchenOrders.find(o => o.id === editBtn.dataset.id);
                        if(order) this.openEditOrderModal(order, 'kitchen');
                    }
                });

                // Order History Actions (Event Delegation)
                document.getElementById('history-items').addEventListener('click', (e) => {
                     const editBtn = e.target.closest('.edit-history-order-btn[data-id]');
                     if (editBtn) {
                        const order = this.orderHistory.find(o => o.id === editBtn.dataset.id);
                        if(order) this.openEditOrderModal(order, 'history');
                    }
                });

                // Edit Order Modal Actions (Event Delegation)
                document.getElementById('edit-order-items').addEventListener('click', (e) => {
                    const qtyBtn = e.target.closest('.edit-qty-btn[data-item-id]');
                    if (qtyBtn) this.handleEditOrderItemChange(qtyBtn.dataset.itemId, qtyBtn.dataset.action);
                    
                    const removeBtn = e.target.closest('.edit-remove-item-btn[data-item-id]');
                    if (removeBtn) this.handleEditOrderItemChange(removeBtn.dataset.itemId, 'remove');
                });
                document.getElementById('edit-discount-percent').addEventListener('input', () => this.applyEditOrderDiscount());
                document.getElementById('cancel-edit-order').addEventListener('click', () => document.getElementById('edit-order-modal').classList.add('hidden'));
                document.getElementById('save-edit-order').addEventListener('click', () => this.saveEditedOrder());
                
                // CSV Export
                document.getElementById('export-csv').addEventListener('click', () => this.downloadCSV());
                
                // Network status listeners
                window.addEventListener('online', () => {
                    this.showSyncIndicator("Back online - syncing data...");
                    // Potentially trigger a full re-sync or check for pending writes if needed
                    setTimeout(() => this.hideSyncIndicator(), 3000);
                });
                window.addEventListener('offline', () => {
                    this.showSyncIndicator("You're offline. Changes saved locally.");
                    // No need to hide immediately, let user see they are offline
                });
            },
            
            // Show the specified tab and hide others
            showTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
                document.getElementById(tabId).classList.remove('hidden');
                
                document.querySelectorAll('[id^="tab-"]').forEach(btn => btn.classList.remove('ring-2', 'ring-white', 'ring-opacity-60', 'font-bold'));
                const buttonId = 'tab-' + tabId.replace('-tab', '');
                const activeButton = document.getElementById(buttonId);
                if (activeButton) {
                    activeButton.classList.add('ring-2', 'ring-white', 'ring-opacity-60', 'font-bold');
                }

                // Specific actions when a tab is shown
                if (tabId === 'summary-tab') {
                    this.updateSalesStats();
                }
                 if (tabId === 'history-tab') {
                    this.updateHistoryTotalSales();
                }
            }
        };
        
        // Initialize the POS application when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            POS.init();
        });
    </script>
</body>
</html>
